<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>台幣匯率儀表板</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0f1117; --card: rgba(255,255,255,0.06); --border: rgba(255,255,255,0.12);
    --buy: #22c55e; --sell: #f97316; --danger: #ef4444; --accent: #6366f1;
  }
  body { background: var(--bg); color: #fff; font-family: system-ui, -apple-system, sans-serif; min-height: 100vh; padding: 2rem 1rem; }
  .container { max-width: 72rem; margin: 0 auto; }
  .glass { background: var(--card); backdrop-filter: blur(16px); border: 1px solid var(--border); border-radius: 1rem; }
  .grid-2 { display: grid; grid-template-columns: 1fr; gap: 1.25rem; }
  @media (min-width: 768px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
  .grid-3 { display: grid; grid-template-columns: 1fr; gap: 1.25rem; }
  @media (min-width: 768px) { .grid-3 { grid-template-columns: 1fr 1fr 1fr; } }
  .grid-charts { display: grid; grid-template-columns: 1fr; gap: 1.25rem; }
  @media (min-width: 1024px) { .grid-charts { grid-template-columns: 1fr 1fr 1fr; } }
  .header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 2rem; }
  .header h1 { font-size: 1.5rem; font-weight: 700; }
  .header p { font-size: 0.875rem; color: rgba(255,255,255,0.5); }
  .btn { background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.7); padding: 0.5rem 1rem; border-radius: 0.75rem; cursor: pointer; font-size: 0.875rem; transition: all 0.2s; }
  .btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .rate-card { padding: 1.5rem; }
  .pair { font-size: 1.125rem; font-weight: 600; color: rgba(255,255,255,0.9); }
  .source { font-size: 0.6875rem; color: rgba(255,255,255,0.35); }
  .big-rate { font-size: 2.5rem; font-weight: 700; letter-spacing: -0.02em; }
  .badge { display: inline-flex; align-items: center; gap: 0.375rem; font-size: 0.75rem; font-weight: 500; padding: 0.25rem 0.75rem; border-radius: 9999px; }
  .badge-buy { background: rgba(34,197,94,0.15); color: var(--buy); }
  .badge-strongbuy { background: rgba(34,197,94,0.25); color: var(--buy); border: 1px solid rgba(34,197,94,0.4); }
  .badge-sell { background: rgba(249,115,22,0.15); color: var(--sell); }
  .badge-strongsell { background: rgba(239,68,68,0.2); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }
  .badge-neutral { background: rgba(99,102,241,0.15); color: var(--accent); }
  .dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; animation: pulse-soft 2s ease-in-out infinite; }
  .badge-buy .dot { background: var(--buy); } .badge-strongbuy .dot { background: var(--buy); } .badge-sell .dot { background: var(--sell); } .badge-strongsell .dot { background: var(--danger); } .badge-neutral .dot { background: var(--accent); }
  @keyframes pulse-soft { 0%,100%{opacity:1} 50%{opacity:0.5} }
  .diff { font-size: 0.875rem; font-weight: 500; }
  .diff.up { color: var(--sell); } .diff.down { color: var(--buy); }
  .alert-box { display: flex; align-items: center; gap: 0.5rem; background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2); border-radius: 0.5rem; padding: 0.5rem 0.75rem; margin: 0.75rem 0; font-size: 0.75rem; color: var(--buy); font-weight: 500; }
  .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.625rem; margin-top: 1rem; }
  .stat { background: rgba(255,255,255,0.03); border-radius: 0.5rem; padding: 0.625rem; }
  .stat-label { font-size: 0.6875rem; color: rgba(255,255,255,0.4); }
  .stat-value { font-size: 0.875rem; font-weight: 600; color: rgba(255,255,255,0.8); margin-top: 2px; }
  .stat-sub { font-size: 0.625rem; color: rgba(255,255,255,0.3); margin-top: 2px; }
  .glow-green { box-shadow: 0 0 30px rgba(34,197,94,0.12); }
  .glow-orange { box-shadow: 0 0 30px rgba(249,115,22,0.12); }
  .glow-accent { box-shadow: 0 0 30px rgba(99,102,241,0.12); }
  .section { padding: 1.5rem; margin-bottom: 1.25rem; }
  .section-title { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.25rem; }
  .section-title h3 { font-size: 1rem; font-weight: 600; color: rgba(255,255,255,0.9); }
  .sub { font-size: 0.75rem; color: rgba(255,255,255,0.3); }
  .vault-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 0.75rem; padding: 1.25rem; }
  .vault-balance { font-size: 1.5rem; font-weight: 700; }
  .pnl-box { border-radius: 0.5rem; border: 1px solid; padding: 0.75rem; margin-top: 1rem; }
  .pnl-gain { border-color: rgba(34,197,94,0.2); background: rgba(34,197,94,0.08); color: var(--buy); }
  .pnl-loss { border-color: rgba(239,68,68,0.2); background: rgba(239,68,68,0.08); color: var(--danger); }
  .pnl-neutral { border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); color: rgba(255,255,255,0.4); }
  .pnl-amount { font-size: 1.125rem; font-weight: 700; }
  .form-grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
  @media (min-width: 480px) { .form-grid { grid-template-columns: 1fr 1fr; } .form-grid .form-submit { grid-column: 1 / -1; } }
  @media (min-width: 640px) { .form-grid { grid-template-columns: 1fr 1fr 1fr 1fr auto; } .form-grid .form-submit { grid-column: auto; } }
  .form-label { font-size: 0.6875rem; color: rgba(255,255,255,0.4); margin-bottom: 0.25rem; display: block; }
  .form-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; color: #fff; outline: none; }
  .form-input:focus { border-color: rgba(99,102,241,0.5); }
  .form-input::placeholder { color: rgba(255,255,255,0.2); }
  select.form-input { appearance: none; cursor: pointer; }
  .btn-accent { background: rgba(99,102,241,0.2); border: 1px solid rgba(99,102,241,0.3); color: var(--accent); font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; }
  .btn-accent:hover { background: rgba(99,102,241,0.3); }
  .btn-link { background: none; border: none; color: rgba(99,102,241,0.6); font-size: 0.625rem; cursor: pointer; margin-left: 0.375rem; }
  .btn-link:hover { color: var(--accent); }
  .preview { background: rgba(255,255,255,0.03); border-radius: 0.5rem; padding: 0.625rem 1rem; font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 0.75rem; }
  .preview strong { color: rgba(255,255,255,0.8); font-weight: 600; }
  .preview .total { color: #fff; font-weight: 700; }
  .history-table { width: 100%; font-size: 0.75rem; border-collapse: collapse; margin-top: 0.75rem; }
  .history-table th { text-align: left; padding: 0.5rem 0; color: rgba(255,255,255,0.3); font-weight: 500; border-bottom: 1px solid rgba(255,255,255,0.05); }
  .history-table td { padding: 0.5rem 0; color: rgba(255,255,255,0.6); border-bottom: 1px solid rgba(255,255,255,0.03); }
  .r { text-align: right; }
  .bold { color: rgba(255,255,255,0.8); font-weight: 500; }
  .btn-del { background: none; border: none; color: rgba(255,255,255,0.2); cursor: pointer; padding: 0.25rem; }
  .btn-del:hover { color: var(--danger); }
  .chart-box { position: relative; height: 260px; margin-top: 0.5rem; }
  .chart-toolbar { display:flex; align-items:center; gap:0.375rem; }
  .chart-toolbar button { background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08); color:rgba(255,255,255,0.4); padding:0.25rem 0.625rem; border-radius:0.375rem; cursor:pointer; font-size:0.6875rem; transition:all 0.15s; }
  .chart-toolbar button:hover { background:rgba(255,255,255,0.1); color:rgba(255,255,255,0.7); }
  .chart-toolbar button.active { background:rgba(99,102,241,0.2); border-color:rgba(99,102,241,0.4); color:var(--accent); font-weight:600; }
  .sma-legend { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.375rem; font-size:0.625rem; color:rgba(255,255,255,0.35); }
  .sma-legend span { display:flex; align-items:center; gap:0.25rem; }
  .sma-dot { width:8px; height:2px; border-radius:1px; display:inline-block; }
  .insight-row { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem; }
  .insight-text { font-size: 0.875rem; color: rgba(255,255,255,0.7); line-height: 1.6; }
  .verdict { border-radius: 0.75rem; border: 1px solid; padding: 1rem; margin-top: 0.5rem; }
  .verdict p { font-size: 0.875rem; font-weight: 500; color: rgba(255,255,255,0.9); }
  .verdict-buy { border-color: rgba(34,197,94,0.3); background: rgba(34,197,94,0.05); }
  .verdict-sell { border-color: rgba(249,115,22,0.3); background: rgba(249,115,22,0.05); }
  .verdict-neutral { border-color: rgba(99,102,241,0.3); background: rgba(99,102,241,0.05); }
  .notice { background:rgba(249,115,22,0.1); border:1px solid rgba(249,115,22,0.3); border-radius:0.75rem; padding:0.625rem 1rem; margin-bottom:1.25rem; font-size:0.8125rem; color:var(--sell); }
  .footer { text-align: center; font-size: 0.75rem; color: rgba(255,255,255,0.2); margin-top: 2.5rem; padding-bottom: 1rem; }
  .hidden { display: none !important; }
  .mb { margin-bottom: 1.25rem; }
  .row-between { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
</style>
</head>
<body>

<div class="container">
  <!-- Notice area (for fallback warning) -->
  <div id="notice"></div>

  <!-- Header -->
  <div class="header">
    <div>
      <h1>台幣匯率儀表板</h1>
      <p>即時匯率 · 換匯訊號 · 庫存追蹤</p>
    </div>
    <div style="display:flex;align-items:center;gap:1rem">
      <span id="updated" style="font-size:0.75rem;color:rgba(255,255,255,0.4)"></span>
      <span id="countdown" style="font-size:0.6875rem;color:rgba(255,255,255,0.25)"></span>
      <button class="btn" onclick="refreshRates(false)">重新整理</button>
    </div>
  </div>

  <!-- Rate Cards -->
  <div class="grid-3 mb">
    <div id="card-usd" class="glass rate-card"></div>
    <div id="card-eur" class="glass rate-card"></div>
    <div id="card-jpy" class="glass rate-card"></div>
  </div>

  <!-- Company Vault -->
  <div id="vault-section" class="glass section glow-accent"></div>

  <!-- Exchange Form -->
  <div id="form-section" class="glass section glow-accent"></div>

  <!-- Charts (only if Chart.js loads) -->
  <div id="charts-area" class="grid-charts mb hidden">
    <div class="glass section glow-accent">
      <div class="row-between">
        <h3 style="font-weight:600;color:rgba(255,255,255,0.9)">USD / TWD</h3>
        <div class="chart-toolbar" id="tb-usd">
          <button onclick="setChartPeriod('usd',30)" class="active">30D</button>
          <button onclick="setChartPeriod('usd',60)">60D</button>
          <button onclick="setChartPeriod('usd',90)">90D</button>
        </div>
      </div>
      <div class="chart-box"><canvas id="chart-usd"></canvas></div>
      <div class="sma-legend"><span><i class="sma-dot" style="background:#f59e0b"></i>SMA10</span><span><i class="sma-dot" style="background:#3b82f6"></i>SMA20</span><span><i class="sma-dot" style="background:#ef4444"></i>SMA30</span></div>
    </div>
    <div class="glass section glow-accent">
      <div class="row-between">
        <h3 style="font-weight:600;color:rgba(255,255,255,0.9)">EUR / TWD</h3>
        <div class="chart-toolbar" id="tb-eur">
          <button onclick="setChartPeriod('eur',30)" class="active">30D</button>
          <button onclick="setChartPeriod('eur',60)">60D</button>
          <button onclick="setChartPeriod('eur',90)">90D</button>
        </div>
      </div>
      <div class="chart-box"><canvas id="chart-eur"></canvas></div>
      <div class="sma-legend"><span><i class="sma-dot" style="background:#f59e0b"></i>SMA10</span><span><i class="sma-dot" style="background:#3b82f6"></i>SMA20</span><span><i class="sma-dot" style="background:#ef4444"></i>SMA30</span></div>
    </div>
    <div class="glass section glow-accent">
      <div class="row-between">
        <h3 style="font-weight:600;color:rgba(255,255,255,0.9)">JPY / TWD（每百圓）</h3>
        <div class="chart-toolbar" id="tb-jpy">
          <button onclick="setChartPeriod('jpy',30)" class="active">30D</button>
          <button onclick="setChartPeriod('jpy',60)">60D</button>
          <button onclick="setChartPeriod('jpy',90)">90D</button>
        </div>
      </div>
      <div class="chart-box"><canvas id="chart-jpy"></canvas></div>
      <div class="sma-legend"><span><i class="sma-dot" style="background:#f59e0b"></i>SMA10</span><span><i class="sma-dot" style="background:#3b82f6"></i>SMA20</span><span><i class="sma-dot" style="background:#ef4444"></i>SMA30</span></div>
    </div>
  </div>

  <!-- Daily Insight -->
  <div id="insight-section" class="glass section glow-accent"></div>

  <div class="footer">資料來源：台灣銀行 + 合作金庫牌告匯率 · 僅供參考，非投資建議</div>
</div>

<script>
// ============================================================
// Global error handler — always show something useful
// ============================================================
window.onerror = function(msg, src, line) {
  console.error('Error:', msg, 'at line', line);
  return false;
};

// ============================================================
// DATA
// ============================================================
var STORAGE_KEY = 'twd-dashboard-exchanges';
var appData = null;
var exchanges = [];
var usdChart = null, eurChart = null, jpyChart = null;
var chartPeriods = { usd: 30, eur: 30, jpy: 30 };

try { exchanges = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch(e) { exchanges = []; }
function saveExchanges() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(exchanges)); } catch(e){} }

function genId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
}

// ============================================================
// BOT Data Fetching (CORS Proxy)
// ============================================================
var HIST_CACHE_KEY = 'twd-hist-cache';
var CORS_PROXIES = [
  function(u) { return 'https://corsproxy.io/?' + encodeURIComponent(u); },
  function(u) { return 'https://api.allorigins.win/raw?url=' + encodeURIComponent(u); }
];
var BOT_TODAY = 'https://rate.bot.com.tw/xrt/flcsv/0/day';
var TCB_URL = 'https://www.findrate.tw/bank/10/'; // 合作金庫 via findrate.tw
var tcbRates = null; // { USD:{spotBuy,spotSell}, EUR:{…}, JPY:{…} }

function fetchViaProxy(url, bustCache) {
  var fetchUrl = bustCache ? url + (url.indexOf('?')>=0?'&':'?') + '_t=' + Date.now() : url;
  var idx = 0;
  function tryNext() {
    if (idx >= CORS_PROXIES.length) return Promise.reject(new Error('proxy failed'));
    var proxyUrl = CORS_PROXIES[idx](fetchUrl);
    idx++;
    return fetch(proxyUrl, bustCache ? {cache:'no-store'} : {}).then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.text();
    }).then(function(text) {
      if (!text || text.length < 50) throw new Error('empty');
      return text;
    }).catch(function() { return tryNext(); });
  }
  return tryNext();
}

function parseBotCsv(text) {
  var lines = text.split('\n');
  var rates = {};
  for (var i = 1; i < lines.length; i++) {
    var line = lines[i].trim();
    if (!line) continue;
    var cols = line.split(',');
    var name = (cols[0] || '').replace(/"/g, '').trim();
    var spotBuy = parseFloat(cols[3]);
    var spotSell = parseFloat(cols[13]);
    if (!spotBuy || !spotSell || isNaN(spotBuy) || isNaN(spotSell)) continue;
    if (name.indexOf('USD') >= 0 && !rates.USD) rates.USD = { spotBuy: spotBuy, spotSell: spotSell };
    else if (name.indexOf('EUR') >= 0 && !rates.EUR) rates.EUR = { spotBuy: spotBuy, spotSell: spotSell };
    else if (name.indexOf('JPY') >= 0 && !rates.JPY) rates.JPY = { spotBuy: spotBuy, spotSell: spotSell };
  }
  return rates;
}

function parseFindRateHtml(html) {
  var rates = {};
  var currencyMap = { '美金': 'USD', '歐元': 'EUR', '日幣': 'JPY', '日圓': 'JPY' };
  // findrate.tw table: cols = [幣別, 現鈔買入, 現鈔賣出, 即期買入, 即期賣出]
  var rows = html.match(/<tr[^>]*>[\s\S]*?<\/tr>/gi) || [];
  for (var i = 0; i < rows.length; i++) {
    var cells = rows[i].match(/<td[^>]*>([\s\S]*?)<\/td>/gi);
    if (!cells || cells.length < 5) continue;
    var cellTexts = cells.map(function(c) { return c.replace(/<[^>]*>/g, '').trim(); });
    var cur = null;
    for (var key in currencyMap) {
      if (cellTexts[0].indexOf(key) >= 0) { cur = currencyMap[key]; break; }
    }
    if (!cur || rates[cur]) continue;
    var spotBuy = parseFloat(cellTexts[3]);
    var spotSell = parseFloat(cellTexts[4]);
    if (!isNaN(spotBuy) && !isNaN(spotSell) && spotBuy > 0 && spotSell > 0) {
      rates[cur] = { spotBuy: spotBuy, spotSell: spotSell };
    }
  }
  return (rates.USD && rates.EUR && rates.JPY) ? rates : null;
}

function fetchTcbRates() {
  return fetchViaProxy(TCB_URL, true).then(function(html) {
    var parsed = parseFindRateHtml(html);
    if (parsed) { tcbRates = parsed; }
    return parsed;
  }).catch(function(e) {
    console.warn('TCB rates failed:', e.message);
    return null;
  });
}

var RATES_JSON_URL = 'data/rates-history.json';

function loadHistCache() {
  try { return JSON.parse(localStorage.getItem(HIST_CACHE_KEY) || '{}'); } catch(e) { return {}; }
}
function saveHistCache(cache) {
  try {
    var keys = Object.keys(cache).sort().reverse().slice(0, 120);
    var trimmed = {};
    for (var i = 0; i < keys.length; i++) trimmed[keys[i]] = cache[keys[i]];
    localStorage.setItem(HIST_CACHE_KEY, JSON.stringify(trimmed));
  } catch(e) {}
}

function fetchRatesHistory() {
  return fetch(RATES_JSON_URL + '?_t=' + Date.now(), { cache: 'no-store' })
    .then(function(res) {
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    })
    .then(function(data) {
      // Merge into localStorage cache
      var cache = loadHistCache();
      var keys = Object.keys(data);
      for (var i = 0; i < keys.length; i++) cache[keys[i]] = data[keys[i]];
      saveHistCache(cache);
      return cache;
    });
}

// ============================================================
// Data Building
// ============================================================
function avg(arr) { return arr.length ? arr.reduce(function(s,n){return s+n},0)/arr.length : 0; }

// Calculate Simple Moving Average for an array of rates
function calcSma(rates, period) {
  var sma = [];
  for (var i = 0; i < rates.length; i++) {
    if (i < period - 1) { sma.push(null); continue; }
    var sum = 0;
    for (var j = i - period + 1; j <= i; j++) sum += rates[j];
    sma.push(parseFloat((sum / period).toFixed(4)));
  }
  return sma;
}

// Multi-SMA signal: compare current rate vs SMA10, SMA20, SMA30
function getSignal(current, sma10, sma20, sma30) {
  var below = 0;
  if (sma10 && current < sma10) below++;
  if (sma20 && current < sma20) below++;
  if (sma30 && current < sma30) below++;
  var avgRef = sma30 || sma20 || sma10 || current;
  var diff = avgRef ? ((current - avgRef) / avgRef) * 100 : 0;
  if (below === 3) return { label:'強力買入', cls:'buy', diff:diff, level:3 };
  if (below === 2) return { label:'適合買入', cls:'buy', diff:diff, level:2 };
  if (below === 1) return { label:'持平觀望', cls:'neutral', diff:diff, level:1 };
  // current >= all SMAs
  var above = 0;
  if (sma10 && current > sma10) above++;
  if (sma20 && current > sma20) above++;
  if (sma30 && current > sma30) above++;
  if (above === 3) return { label:'偏高警示', cls:'sell', diff:diff, level:-3 };
  if (above >= 2) return { label:'高於均線', cls:'sell', diff:diff, level:-2 };
  return { label:'持平觀望', cls:'neutral', diff:diff, level:0 };
}

function buildCurrencyData(pair, currency, spotSell, spotBuy, history) {
  var rates = history.map(function(d){return d.rate});
  var last30 = rates.slice(-30);
  var avgVal = last30.length > 0 ? avg(last30) : spotSell;
  // Calculate current SMA values (last value of each SMA array)
  var sma10arr = calcSma(rates, 10);
  var sma20arr = calcSma(rates, 20);
  var sma30arr = calcSma(rates, 30);
  var sma10 = sma10arr.length > 0 ? sma10arr[sma10arr.length - 1] : null;
  var sma20 = sma20arr.length > 0 ? sma20arr[sma20arr.length - 1] : null;
  var sma30 = sma30arr.length > 0 ? sma30arr[sma30arr.length - 1] : null;
  return {
    pair: pair, currency: currency,
    spotSell: parseFloat(spotSell.toFixed(4)), spotBuy: parseFloat(spotBuy.toFixed(4)),
    spread: parseFloat((spotSell - spotBuy).toFixed(4)),
    avg30d: parseFloat(avgVal.toFixed(4)),
    sma10: sma10, sma20: sma20, sma30: sma30,
    min30d: last30.length > 0 ? parseFloat(Math.min.apply(null, last30).toFixed(4)) : parseFloat(spotSell.toFixed(4)),
    max30d: last30.length > 0 ? parseFloat(Math.max.apply(null, last30).toFixed(4)) : parseFloat(spotSell.toFixed(4)),
    signal: getSignal(spotSell, sma10, sma20, sma30), history: history
  };
}

function buildFallbackData(usdTwd, eurTwd, jpyTwd) {
  // Try localStorage cache for real history; only use single-point fallback if no cache
  var cached = loadHistCache();
  var dates = Object.keys(cached).sort();
  if (dates.length >= 5) {
    var todayRates = {
      USD: { spotBuy: usdTwd * 0.995, spotSell: usdTwd },
      EUR: { spotBuy: eurTwd * 0.984, spotSell: eurTwd },
      JPY: { spotBuy: jpyTwd * 0.988, spotSell: jpyTwd }
    };
    buildBotData(todayRates, cached);
    return;
  }
  // No cache at all — minimal single-point data (no simulated random walk)
  var today = (new Date().getMonth()+1)+'/'+(new Date().getDate());
  appData = {
    usd: buildCurrencyData('USD / TWD', 'USD', usdTwd, usdTwd * 0.995, [{ date: today, rate: usdTwd }]),
    eur: buildCurrencyData('EUR / TWD', 'EUR', eurTwd, eurTwd * 0.984, [{ date: today, rate: eurTwd }]),
    jpy: buildCurrencyData('JPY / TWD', 'JPY', jpyTwd, jpyTwd * 0.988, [{ date: today, rate: jpyTwd }]),
  };
}

function buildBotData(todayRates, historyMap) {
  function makeHist(cur, fallbackRate) {
    // If no historyMap provided, try localStorage cache
    var hmap = historyMap;
    if (!hmap) {
      var cached = loadHistCache();
      if (Object.keys(cached).length >= 5) hmap = cached;
    }
    if (!hmap) return [{ date: (new Date().getMonth()+1)+'/'+(new Date().getDate()), rate: fallbackRate }];
    var dates = Object.keys(hmap).sort();
    var last90 = dates.slice(-90); // Keep 90 days for SMA + period toggle
    return last90.map(function(dateStr) {
      var d = new Date(dateStr);
      var entry = hmap[dateStr];
      return { date: (d.getMonth()+1) + '/' + d.getDate(), rate: entry[cur] ? entry[cur].spotSell : 0 };
    }).filter(function(d) { return d.rate > 0; });
  }
  appData = {
    usd: buildCurrencyData('USD / TWD', 'USD', todayRates.USD.spotSell, todayRates.USD.spotBuy, makeHist('USD', todayRates.USD.spotSell)),
    eur: buildCurrencyData('EUR / TWD', 'EUR', todayRates.EUR.spotSell, todayRates.EUR.spotBuy, makeHist('EUR', todayRates.EUR.spotSell)),
    jpy: buildCurrencyData('JPY / TWD', 'JPY', todayRates.JPY.spotSell, todayRates.JPY.spotBuy, makeHist('JPY', todayRates.JPY.spotSell)),
  };
}

// ============================================================
// INIT — try cached history first, fallback to placeholder
// ============================================================
(function initFromCache() {
  var cache = loadHistCache();
  var dates = Object.keys(cache).sort();
  if (dates.length >= 5) {
    // Build historyMap from cache for initial render
    var latestDate = dates[dates.length - 1];
    var latest = cache[latestDate];
    var todayRates = {
      USD: latest.USD || { spotBuy: 31.525, spotSell: 31.625 },
      EUR: latest.EUR || { spotBuy: 37.225, spotSell: 37.625 },
      JPY: latest.JPY || { spotBuy: 0.2065, spotSell: 0.2095 }
    };
    buildBotData(todayRates, cache);
  } else {
    // No cache: skip rendering until real data arrives — show loading state
    buildFallbackData(31.525, 37.425, 0.2095);
  }
})();
render();

function showNotice(msg, type) {
  var colors = {
    info: 'background:rgba(99,102,241,0.1);border-color:rgba(99,102,241,0.3);color:var(--accent)',
    ok: 'background:rgba(34,197,94,0.1);border-color:rgba(34,197,94,0.3);color:var(--buy)',
    warn: 'background:rgba(249,115,22,0.1);border-color:rgba(249,115,22,0.3);color:var(--sell)'
  };
  document.getElementById('notice').innerHTML = '<div class="notice" style="' + (colors[type] || colors.info) + '">' + msg + '</div>';
}

var lastHistoryMap = null; // cache history between refreshes
var AUTO_REFRESH_MS = 5 * 60 * 1000; // 5 minutes
var refreshTimer = null;
var nextRefreshAt = 0;

function refreshRates(isAuto) {
  var label = isAuto ? '自動更新中...' : '正在連線台灣銀行 + 合作金庫取得即時匯率...';
  showNotice(label, 'info');
  Promise.all([
    fetchViaProxy(BOT_TODAY, true),
    fetchTcbRates()
  ]).then(function(results) {
    var text = results[0];
    var todayRates = parseBotCsv(text);
    if (!todayRates.USD || !todayRates.EUR || !todayRates.JPY) throw new Error('incomplete');
    if (lastHistoryMap) {
      buildBotData(todayRates, lastHistoryMap);
      render();
      var sources = '台灣銀行' + (tcbRates ? ' + 合作金庫' : '');
      showNotice('資料來源：' + sources + ' 牌告匯率（每 5 分鐘自動更新）', 'ok');
      setTimeout(function() { document.getElementById('notice').innerHTML = ''; }, 3000);
    } else {
      buildBotData(todayRates, null);
      render();
      var tcbStatus = tcbRates ? ' + 合作金庫' : '';
      showNotice('已取得台銀' + tcbStatus + '即時匯率，正在載入歷史資料...', 'info');
      return fetchRatesHistory().then(function(historyMap) {
        lastHistoryMap = historyMap;
        var dayCount = Object.keys(historyMap).length;
        if (dayCount >= 5) { buildBotData(todayRates, historyMap); render(); }
        var sources = '台灣銀行' + (tcbRates ? ' + 合作金庫' : '');
        showNotice('資料來源：' + sources + ' 牌告匯率（' + dayCount + ' 日真實歷史 · 每 5 分鐘自動更新）', 'ok');
        setTimeout(function() { document.getElementById('notice').innerHTML = ''; }, 5000);
      });
    }
  }).catch(function(e) {
    console.warn('BOT failed:', e.message);
    if (isAuto) { showNotice('自動更新失敗，將在 5 分鐘後重試', 'warn'); return; }
    // Use localStorage cache if available; no third-party fallback
    var cache = loadHistCache();
    var dates = Object.keys(cache).sort();
    if (dates.length >= 5) {
      var latestDate = dates[dates.length - 1];
      var latest = cache[latestDate];
      var todayRates = {
        USD: latest.USD || { spotBuy: 0, spotSell: 0 },
        EUR: latest.EUR || { spotBuy: 0, spotSell: 0 },
        JPY: latest.JPY || { spotBuy: 0, spotSell: 0 }
      };
      if (todayRates.USD.spotSell && todayRates.EUR.spotSell && todayRates.JPY.spotSell) {
        buildBotData(todayRates, cache);
        render();
        showNotice('無法連線台銀，目前顯示上次快取的牌告匯率（' + latestDate + '）。', 'warn');
      } else {
        showNotice('無法連線台灣銀行取得匯率，請稍後再試。', 'warn');
      }
    } else {
      showNotice('無法連線台灣銀行取得匯率，請檢查網路後重新整理。', 'warn');
    }
  }).then(function() {
    // Schedule next refresh
    nextRefreshAt = Date.now() + AUTO_REFRESH_MS;
    if (refreshTimer) clearTimeout(refreshTimer);
    refreshTimer = setTimeout(function() { refreshRates(true); }, AUTO_REFRESH_MS);
  });
}

// Initial load
refreshRates(false);

// ============================================================
// RENDER
// ============================================================
function render() {
  document.getElementById('updated').textContent = '更新於 ' + new Date().toLocaleString('zh-TW');
  renderCard('card-usd', appData.usd);
  renderCard('card-eur', appData.eur);
  renderCard('card-jpy', appData.jpy);
  renderVault();
  renderForm();
  renderInsight();
  // Charts — only if Chart.js loaded
  if (typeof Chart !== 'undefined') {
    try { renderCharts(); } catch(e) { console.warn('Chart render failed:', e); }
  }
}

function renderCard(id, d) {
  var s = d.signal;
  var isJpy = d.currency === 'JPY';
  var m = isJpy ? 100 : 1;
  var dp = isJpy ? 2 : 4;
  var glowCls = s.cls==='buy'?'glow-green':s.cls==='sell'?'glow-orange':'glow-accent';
  var el = document.getElementById(id);
  el.className = 'glass rate-card ' + glowCls;
  var diffDir = s.diff < 0 ? 'down' : 'up';
  var diffSign = s.diff > 0 ? '+' : '';
  var alertHtml = '';
  if (s.level === 3) alertHtml = '<div class="alert-box">強力買入 — 低於全部三條均線（SMA10/20/30）</div>';
  else if (s.level === 2) alertHtml = '<div class="alert-box">省錢機會 — 低於兩條均線</div>';
  var badgeCls = s.level === 3 ? 'strongbuy' : s.level <= -3 ? 'strongsell' : s.cls;
  var rateLabel = isJpy ? '即期賣出（每百日圓換台幣）' : '即期賣出（你的買入成本）';

  // TCB comparison
  var tcbHtml = '';
  if (tcbRates && tcbRates[d.currency]) {
    var tcb = tcbRates[d.currency];
    var botSell = d.spotSell * m;
    var tcbSell = tcb.spotSell * m;
    var diff = tcbSell - botSell;
    var cheaper = diff < -0.0001 ? '合庫' : diff > 0.0001 ? '台銀' : '相同';
    var diffColor = diff < -0.0001 ? 'var(--buy)' : diff > 0.0001 ? 'var(--buy)' : 'rgba(255,255,255,0.4)';
    tcbHtml =
      '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:0.5rem;padding:0.625rem;margin-top:0.75rem">' +
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem">' +
          '<span style="font-size:0.6875rem;color:rgba(255,255,255,0.4)">銀行比價</span>' +
          '<span style="font-size:0.6875rem;color:'+diffColor+';font-weight:500">'+cheaper+'較便宜</span>' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;font-size:0.75rem">' +
          '<div style="display:flex;justify-content:space-between"><span style="color:rgba(255,255,255,0.5)">台銀賣出</span><span style="color:rgba(255,255,255,0.8);font-weight:600">'+botSell.toFixed(dp)+'</span></div>' +
          '<div style="display:flex;justify-content:space-between"><span style="color:rgba(255,255,255,0.5)">合庫賣出</span><span style="color:rgba(255,255,255,0.8);font-weight:600">'+tcbSell.toFixed(dp)+'</span></div>' +
          '<div style="display:flex;justify-content:space-between"><span style="color:rgba(255,255,255,0.5)">台銀買入</span><span style="color:rgba(255,255,255,0.6)">'+(d.spotBuy*m).toFixed(dp)+'</span></div>' +
          '<div style="display:flex;justify-content:space-between"><span style="color:rgba(255,255,255,0.5)">合庫買入</span><span style="color:rgba(255,255,255,0.6)">'+(tcb.spotBuy*m).toFixed(dp)+'</span></div>' +
        '</div>' +
      '</div>';
  }

  el.innerHTML =
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">' +
      '<div><div class="pair">'+d.pair+'</div><div class="source">台灣銀行牌告</div></div>' +
      '<span class="badge badge-'+badgeCls+'"><span class="dot"></span>'+s.label+'</span>' +
    '</div>' +
    '<div style="margin-bottom:0.25rem"><div style="font-size:0.75rem;color:rgba(255,255,255,0.4);margin-bottom:0.25rem">'+rateLabel+'</div>' +
      '<div class="big-rate">'+(d.spotSell*m).toFixed(dp)+'</div></div>' +
    '<div style="display:flex;align-items:center;gap:0.375rem;margin-bottom:1.25rem">' +
      '<span class="diff '+diffDir+'">'+diffSign+s.diff.toFixed(2)+'%</span>' +
      '<span style="font-size:0.75rem;color:rgba(255,255,255,0.4)">較 30 日均價</span>' +
    '</div>' +
    alertHtml +
    '<div class="stat-grid">' +
      '<div class="stat"><div class="stat-label">SMA10</div><div class="stat-value">'+(d.sma10 ? (d.sma10*m).toFixed(dp) : '-')+'</div><div class="stat-sub" style="color:'+(d.spotSell<d.sma10?'var(--buy)':'var(--sell)')+'">'+( d.sma10 ? (d.spotSell<d.sma10?'▼ 低於':'▲ 高於') : '' )+'</div></div>' +
      '<div class="stat"><div class="stat-label">SMA20</div><div class="stat-value">'+(d.sma20 ? (d.sma20*m).toFixed(dp) : '-')+'</div><div class="stat-sub" style="color:'+(d.spotSell<d.sma20?'var(--buy)':'var(--sell)')+'">'+( d.sma20 ? (d.spotSell<d.sma20?'▼ 低於':'▲ 高於') : '' )+'</div></div>' +
      '<div class="stat"><div class="stat-label">SMA30</div><div class="stat-value">'+(d.sma30 ? (d.sma30*m).toFixed(dp) : '-')+'</div><div class="stat-sub" style="color:'+(d.spotSell<d.sma30?'var(--buy)':'var(--sell)')+'">'+( d.sma30 ? (d.spotSell<d.sma30?'▼ 低於':'▲ 高於') : '' )+'</div></div>' +
      '<div class="stat"><div class="stat-label">匯差</div><div class="stat-value">'+(d.spread*m).toFixed(dp)+'</div><div class="stat-sub">買入 '+(d.spotBuy*m).toFixed(dp)+'</div></div>' +
    '</div>' +
    tcbHtml;
}

// ---- Vault ----
function calcHoldings(currency) {
  var filtered = exchanges.filter(function(r){ return r.currency === currency; });
  if (!filtered.length) return { totalForeign:0, totalTwdSpent:0, avgCost:0, txCount:0 };
  var totalForeign = filtered.reduce(function(s,r){return s+r.amountForeign},0);
  var totalTwdSpent = filtered.reduce(function(s,r){return s+r.twdSpent},0);
  return { totalForeign:totalForeign, totalTwdSpent:totalTwdSpent, avgCost:totalTwdSpent/totalForeign, txCount:filtered.length };
}

function renderVault() {
  document.getElementById('vault-section').innerHTML =
    '<div class="section-title"><span style="font-size:1.25rem">&#127974;</span><h3>公司外匯庫存</h3><span class="sub">庫存匯率計算</span></div>' +
    '<div class="grid-3">'+renderCurrencyVault('USD',appData.usd.spotBuy)+renderCurrencyVault('EUR',appData.eur.spotBuy)+renderCurrencyVault('JPY',appData.jpy.spotBuy)+'</div>';
}

function renderCurrencyVault(currency, spotBuy) {
  var h = calcHoldings(currency);
  var labelMap = { USD:'美元 USD', EUR:'歐元 EUR', JPY:'日幣 JPY' };
  var label = labelMap[currency] || currency;
  if (h.txCount===0) return '<div class="vault-card"><div style="font-size:0.875rem;color:rgba(255,255,255,0.4);margin-bottom:0.75rem">'+label+'</div><p style="font-size:0.75rem;color:rgba(255,255,255,0.25)">尚無換匯紀錄，請在下方新增第一筆。</p></div>';

  var pnl = h.totalForeign * spotBuy - h.totalTwdSpent;
  var pnlPct = (pnl / h.totalTwdSpent) * 100;
  var pnlCls = pnl > 0 ? 'gain' : pnl < 0 ? 'loss' : 'neutral';
  var pnlLabel = pnl > 0 ? '未實現獲利' : pnl < 0 ? '未實現虧損' : '尚無部位';
  var sign = pnl >= 0 ? '+' : '';

  return '<div class="vault-card">' +
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">' +
      '<span style="font-size:0.875rem;font-weight:500;color:rgba(255,255,255,0.8)">'+label+'</span>' +
      '<span style="font-size:0.6875rem;color:rgba(255,255,255,0.3)">共 '+h.txCount+' 筆交易</span></div>' +
    '<div style="margin-bottom:1rem"><div style="font-size:0.75rem;color:rgba(255,255,255,0.4)">目前庫存餘額</div>' +
      '<div class="vault-balance">'+currency+' '+h.totalForeign.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})+'</div></div>' +
    '<div class="stat-grid" style="margin-top:0;margin-bottom:0.75rem">' +
      '<div class="stat"><div class="stat-label">加權平均成本</div><div class="stat-value">'+h.avgCost.toFixed(4)+'</div></div>' +
      '<div class="stat"><div class="stat-label">累計投入</div><div class="stat-value">NT$ '+h.totalTwdSpent.toLocaleString('en-US',{maximumFractionDigits:0})+'</div></div></div>' +
    '<div class="pnl-box pnl-'+pnlCls+'">' +
      '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.25rem">' +
        '<span style="font-size:0.75rem;font-weight:500">'+pnlLabel+'</span>' +
        '<span style="font-size:0.6875rem;color:rgba(255,255,255,0.3)">比較即期買入 '+spotBuy.toFixed(4)+'</span></div>' +
      '<span class="pnl-amount">'+sign+'NT$ '+pnl.toLocaleString('en-US',{maximumFractionDigits:0})+'</span>' +
      '<span style="font-size:0.75rem;margin-left:0.5rem">('+sign+pnlPct.toFixed(2)+'%)</span></div></div>';
}

// ---- Form ----
function renderForm() {
  var histBtn = exchanges.length ? '<button class="btn" onclick="toggleHistory()" id="hist-btn">查看歷史紀錄（'+exchanges.length+'）</button>' : '';
  document.getElementById('form-section').innerHTML =
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem">' +
      '<div class="section-title" style="margin-bottom:0"><span style="font-size:1.25rem">&#10133;</span><h3>新增換匯紀錄</h3></div>'+histBtn+'</div>' +
    '<div class="form-grid">' +
      '<div><label class="form-label">日期</label><input type="date" id="f-date" class="form-input" value="'+new Date().toISOString().slice(0,10)+'"></div>' +
      '<div><label class="form-label">幣別</label><select id="f-currency" class="form-input"><option value="USD">美元 USD</option><option value="EUR">歐元 EUR</option><option value="JPY">日幣 JPY</option></select></div>' +
      '<div><label class="form-label">金額</label><input type="number" id="f-amount" class="form-input" step="0.01" min="0" placeholder="10000" oninput="updatePreview()"></div>' +
      '<div><label class="form-label">匯率 <button class="btn-link" type="button" onclick="prefillRate()">[帶入今日]</button></label><input type="number" id="f-rate" class="form-input" step="0.0001" min="0" placeholder="31.5250" oninput="updatePreview()"></div>' +
      '<div class="form-submit" style="display:flex;align-items:flex-end"><button class="btn-accent" style="width:100%" type="button" onclick="addRecord()">+ 新增</button></div></div>' +
    '<div id="preview" class="preview hidden"></div>' +
    '<div id="history-table" class="hidden"></div>';
}

function prefillRate() {
  var cur = document.getElementById('f-currency').value;
  var rateMap = { USD: appData.usd.spotSell, EUR: appData.eur.spotSell, JPY: appData.jpy.spotSell };
  document.getElementById('f-rate').value = rateMap[cur];
  updatePreview();
}

function updatePreview() {
  var amt = parseFloat(document.getElementById('f-amount').value);
  var rate = parseFloat(document.getElementById('f-rate').value);
  var el = document.getElementById('preview');
  var cur = document.getElementById('f-currency').value;
  if (amt && rate && amt > 0 && rate > 0) {
    el.className = 'preview';
    el.innerHTML = '買入 <strong>'+cur+' '+amt.toLocaleString()+'</strong>，匯率 <strong>'+rate.toFixed(4)+'</strong>，合計 <span class="total">NT$ '+(amt*rate).toLocaleString('en-US',{maximumFractionDigits:0})+'</span>';
  } else { el.className = 'preview hidden'; }
}

function addRecord() {
  var date = document.getElementById('f-date').value;
  var currency = document.getElementById('f-currency').value;
  var amt = parseFloat(document.getElementById('f-amount').value);
  var rate = parseFloat(document.getElementById('f-rate').value);
  if (!amt || amt <= 0 || !rate || rate <= 0) return;
  exchanges.push({ id:genId(), date:date, currency:currency, amountForeign:amt, rate:rate, twdSpent:amt*rate, createdAt:new Date().toISOString() });
  saveExchanges();
  renderVault(); renderForm(); renderInsight();
}

function deleteRecord(id) {
  exchanges = exchanges.filter(function(r){ return r.id !== id; });
  saveExchanges(); renderVault(); renderForm(); renderInsight();
}

function toggleHistory() {
  var el = document.getElementById('history-table');
  var btn = document.getElementById('hist-btn');
  if (el.className.indexOf('hidden') >= 0) {
    el.className = '';
    btn.textContent = '隱藏歷史紀錄（'+exchanges.length+'）';
    var sorted = exchanges.slice().sort(function(a,b){ return b.date.localeCompare(a.date); });
    el.innerHTML = '<table class="history-table"><thead><tr><th>日期</th><th>幣別</th><th class="r">金額</th><th class="r">匯率</th><th class="r">台幣成本</th><th class="r"></th></tr></thead><tbody>' +
      sorted.map(function(r){ return '<tr><td>'+r.date+'</td><td>'+r.currency+'</td><td class="r bold">'+r.amountForeign.toLocaleString('en-US',{minimumFractionDigits:2})+'</td><td class="r">'+r.rate.toFixed(4)+'</td><td class="r bold">'+r.twdSpent.toLocaleString('en-US',{maximumFractionDigits:0})+'</td><td class="r"><button class="btn-del" onclick="deleteRecord(\''+r.id+'\')" title="刪除">&#10005;</button></td></tr>'; }).join('') +
      '</tbody></table>';
  } else {
    el.className = 'hidden';
    btn.textContent = '查看歷史紀錄（'+exchanges.length+'）';
  }
}

// ---- Charts (optional — only if Chart.js CDN loaded) ----
function setChartPeriod(cur, days) {
  chartPeriods[cur] = days;
  // Update toolbar active state
  var tb = document.getElementById('tb-' + cur);
  if (tb) {
    var btns = tb.querySelectorAll('button');
    for (var i = 0; i < btns.length; i++) {
      btns[i].className = btns[i].textContent === days + 'D' ? 'active' : '';
    }
  }
  if (typeof Chart !== 'undefined') renderSingleChart(cur);
}

function sliceHistory(hist, days) {
  return hist.length > days ? hist.slice(-days) : hist;
}

function makeSmaDataset(rates, period, color) {
  var sma = calcSma(rates, period);
  return {
    data: sma, borderColor: color, borderWidth: 1.5,
    borderDash: [4, 3], pointRadius: 0, tension: 0.3,
    fill: false, spanGaps: true
  };
}

function makeChartCfg(data, color, isJpy) {
  var m = isJpy ? 100 : 1;
  var dp = isJpy ? 2 : 4;
  var chartData = data.map(function(d) { return { date: d.date, rate: parseFloat((d.rate * m).toFixed(dp)) }; });
  var rates = chartData.map(function(d) { return d.rate; });
  var labels = chartData.map(function(d) { return d.date; });

  return {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { data: rates, borderColor: color, borderWidth: 2, backgroundColor: color + '20', fill: true, tension: 0.3, pointRadius: 0, pointHoverRadius: 5, pointHoverBackgroundColor: color, order: 0 },
        makeSmaDataset(rates, 10, '#f59e0b'),
        makeSmaDataset(rates, 20, '#3b82f6'),
        makeSmaDataset(rates, 30, '#ef4444')
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(22,24,34,0.9)', borderColor: 'rgba(255,255,255,0.12)', borderWidth: 1,
          titleColor: 'rgba(255,255,255,0.5)', bodyColor: '#fff', bodyFont: { weight: 'bold' },
          filter: function(item) { return item.datasetIndex === 0; },
          callbacks: { label: function(ctx) { return ctx.parsed.y.toFixed(dp); } }
        }
      },
      scales: {
        x: { ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 10 }, maxTicksLimit: 8 }, grid: { color: 'rgba(255,255,255,0.04)' } },
        y: { ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 10 }, callback: function(v) { return v.toFixed(isJpy ? 1 : 2); } }, grid: { color: 'rgba(255,255,255,0.04)' } }
      }
    }
  };
}

function renderSingleChart(cur) {
  var map = { usd: { data: appData.usd, color: '#6366f1', chart: usdChart, isJpy: false },
              eur: { data: appData.eur, color: '#8b5cf6', chart: eurChart, isJpy: false },
              jpy: { data: appData.jpy, color: '#f43f5e', chart: jpyChart, isJpy: true } };
  var c = map[cur];
  var period = chartPeriods[cur];
  var sliced = sliceHistory(c.data.history, period);
  if (c.chart) c.chart.destroy();
  var newChart = new Chart(document.getElementById('chart-' + cur), makeChartCfg(sliced, c.color, c.isJpy));
  if (cur === 'usd') usdChart = newChart;
  else if (cur === 'eur') eurChart = newChart;
  else jpyChart = newChart;
}

function renderCharts() {
  document.getElementById('charts-area').className = 'grid-charts mb';
  renderSingleChart('usd');
  renderSingleChart('eur');
  renderSingleChart('jpy');
}

// ---- Insight ----
function addCurrencyInsight(insights, data, nameZh) {
  var s = data.signal;
  var isJpy = data.currency === 'JPY';
  var m = isJpy ? 100 : 1;
  var dp = isJpy ? 2 : 4;
  // Multi-SMA insight
  if (s.level === 3) {
    insights.push({ color:'var(--buy)', text:nameZh+'低於全部三條均線（SMA10/20/30）——強力買入訊號！目前 '+(data.spotSell*m).toFixed(dp)+' 是近期低點。' });
  } else if (s.level === 2) {
    insights.push({ color:'var(--buy)', text:nameZh+'低於兩條均線，適合買入。即期賣出 '+(data.spotSell*m).toFixed(dp)+' 低於 30 日均價 '+(data.avg30d*m).toFixed(dp)+'。' });
  } else if (s.level === -3) {
    insights.push({ color:'var(--sell)', text:nameZh+'高於全部三條均線——偏高警示！建議暫緩換匯，等待回落。' });
  } else if (s.level === -2) {
    insights.push({ color:'var(--sell)', text:nameZh+'高於多數均線，匯率偏高（均價 '+(data.avg30d*m).toFixed(dp)+'），建議觀望。' });
  } else {
    insights.push({ color:'var(--accent)', text:nameZh+'位於均線交叉附近，目前無明顯方向性訊號。' });
  }
  // Bank comparison insight
  if (tcbRates && tcbRates[data.currency]) {
    var botSell = data.spotSell;
    var tcbSell = tcbRates[data.currency].spotSell;
    var diff = tcbSell - botSell;
    if (Math.abs(diff) > 0.0001) {
      var cheaper = diff > 0 ? '台銀' : '合庫';
      var savePer = Math.abs(diff);
      var saveText = isJpy ? '每萬日圓省 NT$'+(savePer*10000).toFixed(0) : '每千元省 NT$'+(savePer*1000).toFixed(1);
      insights.push({ color:'var(--accent)', text:nameZh+'買入：'+cheaper+'較便宜（價差 '+(isJpy?(savePer*100).toFixed(2):savePer.toFixed(4))+'，'+saveText+'）。' });
    }
  }
}

function renderInsight() {
  var u = appData.usd, e = appData.eur, j = appData.jpy;
  var insights = [];

  addCurrencyInsight(insights, u, '美元');
  addCurrencyInsight(insights, e, '歐元');
  addCurrencyInsight(insights, j, '日幣');

  // SMA summary row
  var smaRow = [u,e,j].map(function(d) {
    var lbl = d.currency;
    var s10 = d.sma10 ? (d.spotSell < d.sma10 ? '▼' : '▲') : '-';
    var s20 = d.sma20 ? (d.spotSell < d.sma20 ? '▼' : '▲') : '-';
    var s30 = d.sma30 ? (d.spotSell < d.sma30 ? '▼' : '▲') : '-';
    return lbl + ' ' + s10 + '/' + s20 + '/' + s30;
  }).join(' · ');
  insights.push({ color:'rgba(255,255,255,0.4)', text:'均線位置（SMA10/20/30）：' + smaRow + '（▼ = 低於均線 = 有利買入）' });

  // Overall verdict based on total SMA score
  var totalLevel = [u,e,j].reduce(function(s,d){ return s + d.signal.level; }, 0);
  var verdict, vCls;
  if (totalLevel >= 6) { verdict='三幣別均低於所有均線——絕佳換匯時機，強力建議買入！'; vCls='verdict-buy'; }
  else if (totalLevel >= 3) { verdict='多數幣別低於均線——今天是換匯的好日子！'; vCls='verdict-buy'; }
  else if (totalLevel >= 1) { verdict='部分幣別出現買入訊號，請參考上方卡片判斷。'; vCls='verdict-neutral'; }
  else if (totalLevel >= -2) { verdict='均線訊號中性——建議持續觀望，等待更明確訊號。'; vCls='verdict-neutral'; }
  else { verdict='多數幣別高於均線——匯率偏高，建議等待回落再換匯。'; vCls='verdict-sell'; }

  var now = new Date();
  var weekdays = ['日','一','二','三','四','五','六'];
  var dateStr = now.getFullYear()+'年'+(now.getMonth()+1)+'月'+now.getDate()+'日 星期'+weekdays[now.getDay()];

  document.getElementById('insight-section').innerHTML =
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem">' +
      '<div class="section-title" style="margin-bottom:0"><span style="font-size:1.25rem">&#10024;</span><h3>每日換匯建議</h3></div>' +
      '<span style="font-size:0.75rem;color:rgba(255,255,255,0.3)">'+dateStr+'</span></div>' +
    insights.map(function(i){ return '<div class="insight-row"><span style="color:'+i.color+';font-size:1.125rem;flex-shrink:0;margin-top:2px">&#9679;</span><p class="insight-text">'+i.text+'</p></div>'; }).join('') +
    '<div class="verdict '+vCls+'"><p>'+verdict+'</p></div>';
}

// ---- Countdown timer for auto-refresh ----
setInterval(function() {
  var el = document.getElementById('countdown');
  if (!el || !nextRefreshAt) return;
  var secs = Math.max(0, Math.round((nextRefreshAt - Date.now()) / 1000));
  var m = Math.floor(secs / 60);
  var s = secs % 60;
  el.textContent = m + ':' + (s < 10 ? '0' : '') + s + ' 後更新';
}, 1000);
</script>

<!-- Chart.js: loaded AFTER page renders, so page works even if CDN fails -->
<script>
(function(){
  var s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js';
  s.onload = function(){
    try { renderCharts(); } catch(e){ console.warn('Charts failed:', e); }
  };
  s.onerror = function(){ console.warn('Chart.js CDN unavailable — charts disabled'); };
  document.head.appendChild(s);
})();
</script>
</body>
</html>
