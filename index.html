<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>台幣匯率儀表板</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0f1117; --card: rgba(255,255,255,0.06); --border: rgba(255,255,255,0.12);
    --buy: #22c55e; --sell: #f97316; --danger: #ef4444; --accent: #6366f1;
  }
  body { background: var(--bg); color: #fff; font-family: system-ui, -apple-system, sans-serif; min-height: 100vh; padding: 2rem 1rem; }
  .container { max-width: 72rem; margin: 0 auto; }
  .glass { background: var(--card); backdrop-filter: blur(16px); border: 1px solid var(--border); border-radius: 1rem; }
  .grid-2 { display: grid; grid-template-columns: 1fr; gap: 1.25rem; }
  @media (min-width: 768px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
  .header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 2rem; }
  .header h1 { font-size: 1.5rem; font-weight: 700; }
  .header p { font-size: 0.875rem; color: rgba(255,255,255,0.5); }
  .btn { background: var(--card); border: 1px solid var(--border); color: rgba(255,255,255,0.7); padding: 0.5rem 1rem; border-radius: 0.75rem; cursor: pointer; font-size: 0.875rem; transition: all 0.2s; }
  .btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
  .rate-card { padding: 1.5rem; }
  .pair { font-size: 1.125rem; font-weight: 600; color: rgba(255,255,255,0.9); }
  .source { font-size: 0.6875rem; color: rgba(255,255,255,0.35); }
  .big-rate { font-size: 2.5rem; font-weight: 700; letter-spacing: -0.02em; }
  .badge { display: inline-flex; align-items: center; gap: 0.375rem; font-size: 0.75rem; font-weight: 500; padding: 0.25rem 0.75rem; border-radius: 9999px; }
  .badge-buy { background: rgba(34,197,94,0.15); color: var(--buy); }
  .badge-sell { background: rgba(249,115,22,0.15); color: var(--sell); }
  .badge-neutral { background: rgba(99,102,241,0.15); color: var(--accent); }
  .dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; animation: pulse-soft 2s ease-in-out infinite; }
  .badge-buy .dot { background: var(--buy); } .badge-sell .dot { background: var(--sell); } .badge-neutral .dot { background: var(--accent); }
  @keyframes pulse-soft { 0%,100%{opacity:1} 50%{opacity:0.5} }
  .diff { font-size: 0.875rem; font-weight: 500; }
  .diff.up { color: var(--sell); } .diff.down { color: var(--buy); }
  .alert-box { display: flex; align-items: center; gap: 0.5rem; background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2); border-radius: 0.5rem; padding: 0.5rem 0.75rem; margin: 0.75rem 0; font-size: 0.75rem; color: var(--buy); font-weight: 500; }
  .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.625rem; margin-top: 1rem; }
  .stat { background: rgba(255,255,255,0.03); border-radius: 0.5rem; padding: 0.625rem; }
  .stat-label { font-size: 0.6875rem; color: rgba(255,255,255,0.4); }
  .stat-value { font-size: 0.875rem; font-weight: 600; color: rgba(255,255,255,0.8); margin-top: 2px; }
  .stat-sub { font-size: 0.625rem; color: rgba(255,255,255,0.3); margin-top: 2px; }
  .glow-green { box-shadow: 0 0 30px rgba(34,197,94,0.12); }
  .glow-orange { box-shadow: 0 0 30px rgba(249,115,22,0.12); }
  .glow-accent { box-shadow: 0 0 30px rgba(99,102,241,0.12); }
  .section { padding: 1.5rem; margin-bottom: 1.25rem; }
  .section-title { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.25rem; }
  .section-title h3 { font-size: 1rem; font-weight: 600; color: rgba(255,255,255,0.9); }
  .sub { font-size: 0.75rem; color: rgba(255,255,255,0.3); }
  .vault-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 0.75rem; padding: 1.25rem; }
  .vault-balance { font-size: 1.5rem; font-weight: 700; }
  .pnl-box { border-radius: 0.5rem; border: 1px solid; padding: 0.75rem; margin-top: 1rem; }
  .pnl-gain { border-color: rgba(34,197,94,0.2); background: rgba(34,197,94,0.08); color: var(--buy); }
  .pnl-loss { border-color: rgba(239,68,68,0.2); background: rgba(239,68,68,0.08); color: var(--danger); }
  .pnl-neutral { border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); color: rgba(255,255,255,0.4); }
  .pnl-amount { font-size: 1.125rem; font-weight: 700; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  @media (min-width: 640px) { .form-grid { grid-template-columns: 1fr 1fr 1fr 1fr auto; } }
  .form-label { font-size: 0.6875rem; color: rgba(255,255,255,0.4); margin-bottom: 0.25rem; display: block; }
  .form-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; color: #fff; outline: none; }
  .form-input:focus { border-color: rgba(99,102,241,0.5); }
  .form-input::placeholder { color: rgba(255,255,255,0.2); }
  select.form-input { appearance: none; cursor: pointer; }
  .btn-accent { background: rgba(99,102,241,0.2); border: 1px solid rgba(99,102,241,0.3); color: var(--accent); font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; }
  .btn-accent:hover { background: rgba(99,102,241,0.3); }
  .btn-link { background: none; border: none; color: rgba(99,102,241,0.6); font-size: 0.625rem; cursor: pointer; margin-left: 0.375rem; }
  .btn-link:hover { color: var(--accent); }
  .preview { background: rgba(255,255,255,0.03); border-radius: 0.5rem; padding: 0.625rem 1rem; font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 0.75rem; }
  .preview strong { color: rgba(255,255,255,0.8); font-weight: 600; }
  .preview .total { color: #fff; font-weight: 700; }
  .history-table { width: 100%; font-size: 0.75rem; border-collapse: collapse; margin-top: 0.75rem; }
  .history-table th { text-align: left; padding: 0.5rem 0; color: rgba(255,255,255,0.3); font-weight: 500; border-bottom: 1px solid rgba(255,255,255,0.05); }
  .history-table td { padding: 0.5rem 0; color: rgba(255,255,255,0.6); border-bottom: 1px solid rgba(255,255,255,0.03); }
  .r { text-align: right; }
  .bold { color: rgba(255,255,255,0.8); font-weight: 500; }
  .btn-del { background: none; border: none; color: rgba(255,255,255,0.2); cursor: pointer; padding: 0.25rem; }
  .btn-del:hover { color: var(--danger); }
  .chart-box { position: relative; height: 240px; margin-top: 0.5rem; }
  .insight-row { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem; }
  .insight-text { font-size: 0.875rem; color: rgba(255,255,255,0.7); line-height: 1.6; }
  .verdict { border-radius: 0.75rem; border: 1px solid; padding: 1rem; margin-top: 0.5rem; }
  .verdict p { font-size: 0.875rem; font-weight: 500; color: rgba(255,255,255,0.9); }
  .verdict-buy { border-color: rgba(34,197,94,0.3); background: rgba(34,197,94,0.05); }
  .verdict-sell { border-color: rgba(249,115,22,0.3); background: rgba(249,115,22,0.05); }
  .verdict-neutral { border-color: rgba(99,102,241,0.3); background: rgba(99,102,241,0.05); }
  .notice { background:rgba(249,115,22,0.1); border:1px solid rgba(249,115,22,0.3); border-radius:0.75rem; padding:0.625rem 1rem; margin-bottom:1.25rem; font-size:0.8125rem; color:var(--sell); }
  .footer { text-align: center; font-size: 0.75rem; color: rgba(255,255,255,0.2); margin-top: 2.5rem; padding-bottom: 1rem; }
  .hidden { display: none !important; }
  .mb { margin-bottom: 1.25rem; }
  .row-between { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
</style>
</head>
<body>

<div class="container">
  <!-- Notice area (for fallback warning) -->
  <div id="notice"></div>

  <!-- Header -->
  <div class="header">
    <div>
      <h1>台幣匯率儀表板</h1>
      <p>即時匯率 · 換匯訊號 · 庫存追蹤</p>
    </div>
    <div style="display:flex;align-items:center;gap:1rem">
      <span id="updated" style="font-size:0.75rem;color:rgba(255,255,255,0.4)"></span>
      <button class="btn" onclick="location.reload()">重新整理</button>
    </div>
  </div>

  <!-- Rate Cards -->
  <div class="grid-2 mb">
    <div id="card-usd" class="glass rate-card"></div>
    <div id="card-eur" class="glass rate-card"></div>
  </div>

  <!-- Company Vault -->
  <div id="vault-section" class="glass section glow-accent"></div>

  <!-- Exchange Form -->
  <div id="form-section" class="glass section glow-accent"></div>

  <!-- Charts (only if Chart.js loads) -->
  <div id="charts-area" class="grid-2 mb hidden">
    <div class="glass section glow-accent">
      <div class="row-between">
        <h3 style="font-weight:600;color:rgba(255,255,255,0.9)">USD / TWD — 30 日走勢</h3>
        <span id="usd-avg-label" style="font-size:0.75rem;color:rgba(255,255,255,0.4)"></span>
      </div>
      <div class="chart-box"><canvas id="chart-usd"></canvas></div>
    </div>
    <div class="glass section glow-accent">
      <div class="row-between">
        <h3 style="font-weight:600;color:rgba(255,255,255,0.9)">EUR / TWD — 30 日走勢</h3>
        <span id="eur-avg-label" style="font-size:0.75rem;color:rgba(255,255,255,0.4)"></span>
      </div>
      <div class="chart-box"><canvas id="chart-eur"></canvas></div>
    </div>
  </div>

  <!-- Daily Insight -->
  <div id="insight-section" class="glass section glow-accent"></div>

  <div class="footer">資料來源：ExchangeRate-API / 離線參考值 · 僅供參考，非投資建議</div>
</div>

<script>
// ============================================================
// Global error handler — always show something useful
// ============================================================
window.onerror = function(msg, src, line) {
  console.error('Error:', msg, 'at line', line);
  return false;
};

// ============================================================
// DATA
// ============================================================
var STORAGE_KEY = 'twd-dashboard-exchanges';
var appData = null;
var exchanges = [];
var usdChart = null, eurChart = null;

try { exchanges = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch(e) { exchanges = []; }
function saveExchanges() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(exchanges)); } catch(e){} }

function genId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
}

function genHistory(current, volatility) {
  var data = [], now = new Date(), rate = current * (1 + (Math.random()-0.5)*0.02);
  for (var i = 29; i >= 1; i--) {
    var d = new Date(now); d.setDate(d.getDate() - i);
    rate += (Math.random()-0.48)*volatility;
    rate = Math.max(rate, current*0.95); rate = Math.min(rate, current*1.05);
    data.push({ date: (d.getMonth()+1)+'/'+d.getDate(), rate: parseFloat(rate.toFixed(4)) });
  }
  data.push({ date: (now.getMonth()+1)+'/'+now.getDate(), rate: parseFloat(current.toFixed(4)) });
  return data;
}

function avg(arr) { return arr.reduce(function(s,n){return s+n},0)/arr.length; }

function getSignal(current, avg30) {
  var diff = ((current-avg30)/avg30)*100;
  if (diff < -0.3) return { label:'適合買入', cls:'buy', diff:diff };
  if (diff > 0.3) return { label:'高於均價', cls:'sell', diff:diff };
  return { label:'持平觀望', cls:'neutral', diff:diff };
}

function buildAppData(usdTwd, eurTwd) {
  var usdSpotBuy = parseFloat((usdTwd * 0.995).toFixed(4));
  var eurSpotBuy = parseFloat((eurTwd * 0.984).toFixed(4));
  var usdHist = genHistory(usdTwd, 0.15);
  var eurHist = genHistory(eurTwd, 0.18);
  var usdAvg = avg(usdHist.map(function(d){return d.rate}));
  var eurAvg = avg(eurHist.map(function(d){return d.rate}));
  appData = {
    usd: { pair:'USD / TWD', currency:'USD', spotSell:parseFloat(usdTwd.toFixed(4)), spotBuy:usdSpotBuy,
      spread:parseFloat((usdTwd-usdSpotBuy).toFixed(4)), avg30d:parseFloat(usdAvg.toFixed(4)),
      min30d:parseFloat(Math.min.apply(null,usdHist.map(function(d){return d.rate})).toFixed(4)),
      max30d:parseFloat(Math.max.apply(null,usdHist.map(function(d){return d.rate})).toFixed(4)),
      signal:getSignal(usdTwd, usdAvg), history:usdHist },
    eur: { pair:'EUR / TWD', currency:'EUR', spotSell:parseFloat(eurTwd.toFixed(4)), spotBuy:eurSpotBuy,
      spread:parseFloat((eurTwd-eurSpotBuy).toFixed(4)), avg30d:parseFloat(eurAvg.toFixed(4)),
      min30d:parseFloat(Math.min.apply(null,eurHist.map(function(d){return d.rate})).toFixed(4)),
      max30d:parseFloat(Math.max.apply(null,eurHist.map(function(d){return d.rate})).toFixed(4)),
      signal:getSignal(eurTwd, eurAvg), history:eurHist },
  };
}

// ============================================================
// INIT — build data immediately (no waiting), then try API
// ============================================================
buildAppData(31.525, 37.425);
render();

// Try live API in the background — if it works, re-render with real data
var API_URL = 'https://v6.exchangerate-api.com/v6/3b25ca2cc8cbdb1d0e6611e3/latest/USD';
try {
  fetch(API_URL).then(function(res){ return res.json(); }).then(function(json){
    if (json.result === 'success') {
      var usdTwd = json.conversion_rates.TWD;
      var eurTwd = usdTwd / json.conversion_rates.EUR;
      buildAppData(usdTwd, eurTwd);
      render();
      document.getElementById('notice').innerHTML = '';
    }
  }).catch(function(e){
    console.warn('API unavailable:', e.message);
    document.getElementById('notice').innerHTML = '<div class="notice">目前使用離線參考匯率。如需即時資料，請透過 HTTP 伺服器開啟此頁面。</div>';
  });
} catch(e) {
  document.getElementById('notice').innerHTML = '<div class="notice">目前使用離線參考匯率。</div>';
}

// ============================================================
// RENDER
// ============================================================
function render() {
  document.getElementById('updated').textContent = '更新於 ' + new Date().toLocaleString('zh-TW');
  renderCard('card-usd', appData.usd);
  renderCard('card-eur', appData.eur);
  renderVault();
  renderForm();
  renderInsight();
  // Charts — only if Chart.js loaded
  if (typeof Chart !== 'undefined') {
    try { renderCharts(); } catch(e) { console.warn('Chart render failed:', e); }
  }
}

function renderCard(id, d) {
  var s = d.signal;
  var glowCls = s.cls==='buy'?'glow-green':s.cls==='sell'?'glow-orange':'glow-accent';
  var el = document.getElementById(id);
  el.className = 'glass rate-card ' + glowCls;
  var diffDir = s.diff < 0 ? 'down' : 'up';
  var diffSign = s.diff > 0 ? '+' : '';
  var alertHtml = s.cls==='buy' ? '<div class="alert-box">省錢機會 — 低於 30 日均價 '+Math.abs(s.diff).toFixed(2)+'%</div>' : '';

  el.innerHTML =
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">' +
      '<div><div class="pair">'+d.pair+'</div><div class="source">即時匯率</div></div>' +
      '<span class="badge badge-'+s.cls+'"><span class="dot"></span>'+s.label+'</span>' +
    '</div>' +
    '<div style="margin-bottom:0.25rem"><div style="font-size:0.75rem;color:rgba(255,255,255,0.4);margin-bottom:0.25rem">即期賣出（你的買入成本）</div>' +
      '<div class="big-rate">'+d.spotSell.toFixed(4)+'</div></div>' +
    '<div style="display:flex;align-items:center;gap:0.375rem;margin-bottom:1.25rem">' +
      '<span class="diff '+diffDir+'">'+diffSign+s.diff.toFixed(2)+'%</span>' +
      '<span style="font-size:0.75rem;color:rgba(255,255,255,0.4)">較 30 日均價</span>' +
    '</div>' +
    alertHtml +
    '<div class="stat-grid">' +
      '<div class="stat"><div class="stat-label">30日均價</div><div class="stat-value">'+d.avg30d.toFixed(4)+'</div></div>' +
      '<div class="stat"><div class="stat-label">匯差(買賣價差)</div><div class="stat-value">'+d.spread.toFixed(4)+'</div><div class="stat-sub">即期買入 '+d.spotBuy.toFixed(4)+'</div></div>' +
      '<div class="stat"><div class="stat-label">30日最低</div><div class="stat-value">'+d.min30d.toFixed(4)+'</div></div>' +
      '<div class="stat"><div class="stat-label">30日最高</div><div class="stat-value">'+d.max30d.toFixed(4)+'</div></div>' +
    '</div>';
}

// ---- Vault ----
function calcHoldings(currency) {
  var filtered = exchanges.filter(function(r){ return r.currency === currency; });
  if (!filtered.length) return { totalForeign:0, totalTwdSpent:0, avgCost:0, txCount:0 };
  var totalForeign = filtered.reduce(function(s,r){return s+r.amountForeign},0);
  var totalTwdSpent = filtered.reduce(function(s,r){return s+r.twdSpent},0);
  return { totalForeign:totalForeign, totalTwdSpent:totalTwdSpent, avgCost:totalTwdSpent/totalForeign, txCount:filtered.length };
}

function renderVault() {
  document.getElementById('vault-section').innerHTML =
    '<div class="section-title"><span style="font-size:1.25rem">&#127974;</span><h3>公司外匯庫存</h3><span class="sub">庫存匯率計算</span></div>' +
    '<div class="grid-2">'+renderCurrencyVault('USD',appData.usd.spotBuy)+renderCurrencyVault('EUR',appData.eur.spotBuy)+'</div>';
}

function renderCurrencyVault(currency, spotBuy) {
  var h = calcHoldings(currency);
  var label = currency==='USD'?'美元 USD':'歐元 EUR';
  if (h.txCount===0) return '<div class="vault-card"><div style="font-size:0.875rem;color:rgba(255,255,255,0.4);margin-bottom:0.75rem">'+label+'</div><p style="font-size:0.75rem;color:rgba(255,255,255,0.25)">尚無換匯紀錄，請在下方新增第一筆。</p></div>';

  var pnl = h.totalForeign * spotBuy - h.totalTwdSpent;
  var pnlPct = (pnl / h.totalTwdSpent) * 100;
  var pnlCls = pnl > 0 ? 'gain' : pnl < 0 ? 'loss' : 'neutral';
  var pnlLabel = pnl > 0 ? '未實現獲利' : pnl < 0 ? '未實現虧損' : '尚無部位';
  var sign = pnl >= 0 ? '+' : '';

  return '<div class="vault-card">' +
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">' +
      '<span style="font-size:0.875rem;font-weight:500;color:rgba(255,255,255,0.8)">'+label+'</span>' +
      '<span style="font-size:0.6875rem;color:rgba(255,255,255,0.3)">共 '+h.txCount+' 筆交易</span></div>' +
    '<div style="margin-bottom:1rem"><div style="font-size:0.75rem;color:rgba(255,255,255,0.4)">目前庫存餘額</div>' +
      '<div class="vault-balance">'+currency+' '+h.totalForeign.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})+'</div></div>' +
    '<div class="stat-grid" style="margin-top:0;margin-bottom:0.75rem">' +
      '<div class="stat"><div class="stat-label">加權平均成本</div><div class="stat-value">'+h.avgCost.toFixed(4)+'</div></div>' +
      '<div class="stat"><div class="stat-label">累計投入</div><div class="stat-value">NT$ '+h.totalTwdSpent.toLocaleString('en-US',{maximumFractionDigits:0})+'</div></div></div>' +
    '<div class="pnl-box pnl-'+pnlCls+'">' +
      '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.25rem">' +
        '<span style="font-size:0.75rem;font-weight:500">'+pnlLabel+'</span>' +
        '<span style="font-size:0.6875rem;color:rgba(255,255,255,0.3)">比較即期買入 '+spotBuy.toFixed(4)+'</span></div>' +
      '<span class="pnl-amount">'+sign+'NT$ '+pnl.toLocaleString('en-US',{maximumFractionDigits:0})+'</span>' +
      '<span style="font-size:0.75rem;margin-left:0.5rem">('+sign+pnlPct.toFixed(2)+'%)</span></div></div>';
}

// ---- Form ----
function renderForm() {
  var histBtn = exchanges.length ? '<button class="btn" onclick="toggleHistory()" id="hist-btn">查看歷史紀錄（'+exchanges.length+'）</button>' : '';
  document.getElementById('form-section').innerHTML =
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem">' +
      '<div class="section-title" style="margin-bottom:0"><span style="font-size:1.25rem">&#10133;</span><h3>新增換匯紀錄</h3></div>'+histBtn+'</div>' +
    '<div class="form-grid">' +
      '<div><label class="form-label">日期</label><input type="date" id="f-date" class="form-input" value="'+new Date().toISOString().slice(0,10)+'"></div>' +
      '<div><label class="form-label">幣別</label><select id="f-currency" class="form-input"><option value="USD">美元 USD</option><option value="EUR">歐元 EUR</option></select></div>' +
      '<div><label class="form-label">金額</label><input type="number" id="f-amount" class="form-input" step="0.01" min="0" placeholder="10000" oninput="updatePreview()"></div>' +
      '<div><label class="form-label">匯率 <button class="btn-link" type="button" onclick="prefillRate()">[帶入今日]</button></label><input type="number" id="f-rate" class="form-input" step="0.0001" min="0" placeholder="31.5250" oninput="updatePreview()"></div>' +
      '<div style="display:flex;align-items:flex-end"><button class="btn-accent" style="width:100%" type="button" onclick="addRecord()">+ 新增</button></div></div>' +
    '<div id="preview" class="preview hidden"></div>' +
    '<div id="history-table" class="hidden"></div>';
}

function prefillRate() {
  var cur = document.getElementById('f-currency').value;
  document.getElementById('f-rate').value = (cur==='USD' ? appData.usd.spotSell : appData.eur.spotSell);
  updatePreview();
}

function updatePreview() {
  var amt = parseFloat(document.getElementById('f-amount').value);
  var rate = parseFloat(document.getElementById('f-rate').value);
  var el = document.getElementById('preview');
  var cur = document.getElementById('f-currency').value;
  if (amt && rate && amt > 0 && rate > 0) {
    el.className = 'preview';
    el.innerHTML = '買入 <strong>'+cur+' '+amt.toLocaleString()+'</strong>，匯率 <strong>'+rate.toFixed(4)+'</strong>，合計 <span class="total">NT$ '+(amt*rate).toLocaleString('en-US',{maximumFractionDigits:0})+'</span>';
  } else { el.className = 'preview hidden'; }
}

function addRecord() {
  var date = document.getElementById('f-date').value;
  var currency = document.getElementById('f-currency').value;
  var amt = parseFloat(document.getElementById('f-amount').value);
  var rate = parseFloat(document.getElementById('f-rate').value);
  if (!amt || amt <= 0 || !rate || rate <= 0) return;
  exchanges.push({ id:genId(), date:date, currency:currency, amountForeign:amt, rate:rate, twdSpent:amt*rate, createdAt:new Date().toISOString() });
  saveExchanges();
  renderVault(); renderForm(); renderInsight();
}

function deleteRecord(id) {
  exchanges = exchanges.filter(function(r){ return r.id !== id; });
  saveExchanges(); renderVault(); renderForm(); renderInsight();
}

function toggleHistory() {
  var el = document.getElementById('history-table');
  var btn = document.getElementById('hist-btn');
  if (el.className.indexOf('hidden') >= 0) {
    el.className = '';
    btn.textContent = '隱藏歷史紀錄（'+exchanges.length+'）';
    var sorted = exchanges.slice().sort(function(a,b){ return b.date.localeCompare(a.date); });
    el.innerHTML = '<table class="history-table"><thead><tr><th>日期</th><th>幣別</th><th class="r">金額</th><th class="r">匯率</th><th class="r">台幣成本</th><th class="r"></th></tr></thead><tbody>' +
      sorted.map(function(r){ return '<tr><td>'+r.date+'</td><td>'+r.currency+'</td><td class="r bold">'+r.amountForeign.toLocaleString('en-US',{minimumFractionDigits:2})+'</td><td class="r">'+r.rate.toFixed(4)+'</td><td class="r bold">'+r.twdSpent.toLocaleString('en-US',{maximumFractionDigits:0})+'</td><td class="r"><button class="btn-del" onclick="deleteRecord(\''+r.id+'\')" title="刪除">&#10005;</button></td></tr>'; }).join('') +
      '</tbody></table>';
  } else {
    el.className = 'hidden';
    btn.textContent = '查看歷史紀錄（'+exchanges.length+'）';
  }
}

// ---- Charts (optional — only if Chart.js CDN loaded) ----
function renderCharts() {
  document.getElementById('charts-area').className = 'grid-2 mb';
  document.getElementById('usd-avg-label').textContent = '均價：'+appData.usd.avg30d.toFixed(4);
  document.getElementById('eur-avg-label').textContent = '均價：'+appData.eur.avg30d.toFixed(4);

  function makeCfg(data, avgVal, color) {
    return {
      type: 'line',
      data: { labels: data.map(function(d){return d.date}), datasets: [{
        data: data.map(function(d){return d.rate}), borderColor: color, borderWidth: 2,
        backgroundColor: color+'20', fill: true, tension: 0.3, pointRadius: 0,
        pointHoverRadius: 5, pointHoverBackgroundColor: color
      }]},
      options: { responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false },
          tooltip: { backgroundColor:'rgba(22,24,34,0.9)', borderColor:'rgba(255,255,255,0.12)', borderWidth:1,
            titleColor:'rgba(255,255,255,0.5)', bodyColor:'#fff', bodyFont:{weight:'bold'},
            callbacks: { label: function(ctx){return ctx.parsed.y.toFixed(4)} } } },
        scales: {
          x: { ticks: { color:'rgba(255,255,255,0.3)', font:{size:11}, maxTicksLimit:8 }, grid: { color:'rgba(255,255,255,0.04)' } },
          y: { ticks: { color:'rgba(255,255,255,0.3)', font:{size:11}, callback: function(v){return v.toFixed(1)} }, grid: { color:'rgba(255,255,255,0.04)' } }
        }
      },
      plugins: [{ id:'avg', beforeDraw: function(chart) {
        var y = chart.scales.y.getPixelForValue(avgVal);
        if (y < chart.chartArea.top || y > chart.chartArea.bottom) return;
        var ctx = chart.ctx; ctx.save();
        ctx.strokeStyle = 'rgba(255,255,255,0.15)'; ctx.setLineDash([6,4]); ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(chart.chartArea.left, y); ctx.lineTo(chart.chartArea.right, y); ctx.stroke();
        ctx.fillStyle = 'rgba(255,255,255,0.25)'; ctx.font = '10px sans-serif';
        ctx.fillText('均價 '+avgVal.toFixed(4), chart.chartArea.right - 85, y - 6);
        ctx.restore();
      }}]
    };
  }
  if (usdChart) usdChart.destroy();
  if (eurChart) eurChart.destroy();
  usdChart = new Chart(document.getElementById('chart-usd'), makeCfg(appData.usd.history, appData.usd.avg30d, '#6366f1'));
  eurChart = new Chart(document.getElementById('chart-eur'), makeCfg(appData.eur.history, appData.eur.avg30d, '#8b5cf6'));
}

// ---- Insight ----
function renderInsight() {
  var u = appData.usd, e = appData.eur;
  var insights = [];

  if (u.signal.diff < -0.3) {
    insights.push({ color:'var(--buy)', text:'美元即期賣出低於 30 日均價 '+Math.abs(u.signal.diff).toFixed(2)+'%，每美元可省 NT$'+(u.avg30d-u.spotSell).toFixed(3)+'，是換匯好時機。' });
  } else if (u.signal.diff > 0.3) {
    insights.push({ color:'var(--sell)', text:'美元即期賣出高於 30 日均價 '+u.signal.diff.toFixed(2)+'%（均價 '+u.avg30d.toFixed(2)+'），建議觀望。' });
  } else {
    insights.push({ color:'var(--accent)', text:'美元即期賣出接近 30 日均價，目前無明顯換匯優勢。' });
  }

  if (e.signal.diff < -0.3) {
    insights.push({ color:'var(--buy)', text:'歐元即期賣出低於均價 '+Math.abs(e.signal.diff).toFixed(2)+'%，每歐元可省 NT$'+(e.avg30d-e.spotSell).toFixed(3)+'。' });
  } else if (e.signal.diff > 0.3) {
    insights.push({ color:'var(--sell)', text:'歐元即期賣出高於均價 '+e.signal.diff.toFixed(2)+'%（均價 '+e.avg30d.toFixed(2)+'），不建議今日換匯。' });
  } else {
    insights.push({ color:'var(--accent)', text:'歐元即期賣出在均價附近盤整，無明顯訊號。' });
  }

  insights.push({ color:'rgba(255,255,255,0.4)', text:'今日匯差：美元 '+u.spread.toFixed(3)+' · 歐元 '+e.spread.toFixed(3)+'（越小代表市場越緊）' });

  var buyCount = [u,e].filter(function(d){return d.signal.cls==='buy'}).length;
  var verdict, vCls;
  if (buyCount===2) { verdict='美元與歐元皆低於 30 日均價——今天是換匯的好日子！'; vCls='verdict-buy'; }
  else if (buyCount===1) { verdict='訊號不一致——其中一種幣別較有利，請參考上方卡片。'; vCls='verdict-neutral'; }
  else { verdict='目前無省錢機會，匯率在均價或以上，建議再等等。'; vCls='verdict-sell'; }

  var now = new Date();
  var weekdays = ['日','一','二','三','四','五','六'];
  var dateStr = now.getFullYear()+'年'+(now.getMonth()+1)+'月'+now.getDate()+'日 星期'+weekdays[now.getDay()];

  document.getElementById('insight-section').innerHTML =
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem">' +
      '<div class="section-title" style="margin-bottom:0"><span style="font-size:1.25rem">&#10024;</span><h3>每日換匯建議</h3></div>' +
      '<span style="font-size:0.75rem;color:rgba(255,255,255,0.3)">'+dateStr+'</span></div>' +
    insights.map(function(i){ return '<div class="insight-row"><span style="color:'+i.color+';font-size:1.125rem;flex-shrink:0;margin-top:2px">&#9679;</span><p class="insight-text">'+i.text+'</p></div>'; }).join('') +
    '<div class="verdict '+vCls+'"><p>'+verdict+'</p></div>';
}
</script>

<!-- Chart.js: loaded AFTER page renders, so page works even if CDN fails -->
<script>
(function(){
  var s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js';
  s.onload = function(){
    try { renderCharts(); } catch(e){ console.warn('Charts failed:', e); }
  };
  s.onerror = function(){ console.warn('Chart.js CDN unavailable — charts disabled'); };
  document.head.appendChild(s);
})();
</script>
</body>
</html>
